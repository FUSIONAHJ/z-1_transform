<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>逆Z变换动态实验台 - 部分分式展开法</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --danger: #dc2626;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --highlight: #fef08a;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--card);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* 顶部导航 */
        .header {
            background: var(--primary);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 { margin: 0; font-size: 1.5rem; }
        .header p { margin: 5px 0 0; opacity: 0.9; font-size: 0.9rem; }

        .tabs {
            display: flex;
            background: #e2e8f0;
        }
        .tab-btn {
            flex: 1;
            padding: 15px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            color: #64748b;
            transition: all 0.2s;
            border-bottom: 4px solid transparent;
        }
        .tab-btn:hover { background: #cbd5e1; }
        .tab-btn.active {
            color: var(--primary);
            background: white;
            border-bottom-color: var(--primary);
        }

        /* 模块内容区 */
        .module {
            display: none;
            padding: 30px;
            min-height: 400px;
        }
        .module.active { display: block; }

        /* 数学公式样式 (CSS渲染) */
        .math-font {
            font-family: 'Times New Roman', serif;
            font-style: italic;
        }
        .math-display {
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Times New Roman', serif;
            font-size: 1.5rem;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        .fraction {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            vertical-align: middle;
            margin: 0 5px;
        }
        .numerator {
            border-bottom: 2px solid currentColor;
            padding: 0 5px;
            text-align: center;
            width: 100%;
        }
        .denominator {
            padding: 0 5px;
            text-align: center;
            width: 100%;
        }
        .math-symbol { margin: 0 8px; }
        
        /* 交互按钮 */
        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.1s;
            font-size: 1rem;
            margin: 5px;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }

        /* 模块特有样式 */
        /* Module 1 */
        .feedback-box {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            display: none;
        }
        .feedback-error { background: #fee2e2; color: var(--danger); }
        .feedback-success { background: #dcfce7; color: var(--success); }

        /* Module 2 */
        .term-box {
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 6px;
            border: 2px dashed #cbd5e1;
            transition: all 0.3s;
            position: relative;
        }
        .term-box:hover {
            border-color: var(--primary);
            background: #eff6ff;
        }
        .term-box.active {
            background: var(--highlight);
            border-color: #eab308;
        }
        
        .calculation-card {
            background: #fff;
            border: 1px solid #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s;
        }
        .calculation-card.visible {
            opacity: 1;
            transform: translateY(0);
        }
        .cover-up {
            color: #94a3b8;
            text-decoration: line-through;
            opacity: 0.5;
        }
        .sub-val {
            color: var(--danger);
            font-weight: bold;
        }

        /* Module 3 */
        .viz-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            align-items: flex-start;
        }
        .canvas-wrapper {
            position: relative;
            width: 300px;
            height: 300px;
        }
        svg {
            background: #f8fafc;
            border-radius: 50%;
            border: 1px solid #e2e8f0;
        }
        .control-panel {
            flex: 1;
            min-width: 300px;
            background: #f1f5f9;
            padding: 20px;
            border-radius: 8px;
        }
        input[type=range] {
            width: 100%;
            margin: 15px 0;
        }
        .result-equation {
            font-size: 1.2rem;
            background: white;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid var(--primary);
            margin-top: 20px;
        }
        .pole-marker { font-weight: bold; font-family: sans-serif; cursor: default; }

        /* Guide Text */
        .guide-text {
            color: #64748b;
            font-size: 0.95rem;
            margin-bottom: 20px;
            border-left: 3px solid #cbd5e1;
            padding-left: 10px;
        }

    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>逆Z变换：部分分式展开法</h1>
        <p>Interactive Workbench for Inverse Z-Transform</p>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab(1)">第一步：标准化</button>
        <button class="tab-btn" onclick="switchTab(2)" id="btn-tab-2" disabled>第二步：求系数</button>
        <button class="tab-btn" onclick="switchTab(3)" id="btn-tab-3" disabled>第三步：ROC与反变换</button>
    </div>

    <!-- Module 1: Pre-processing -->
    <div id="mod1" class="module active">
        <div class="guide-text">
            <strong>任务：</strong> 已知 <span class="math-font">X(z)</span> 如下，我们需要将其展开。请选择正确的起始步骤。<br>
            很多学生在这一步会直接展开，导致最后反变换时缺少一个 <span class="math-font">z</span>，这是最常见的错误。
        </div>

        <div class="math-display" id="eq1-display">
            <span>X(z) = </span>
            <div class="fraction">
                <span class="numerator">z<sup>2</sup></span>
                <span class="denominator">(z-1)(z-2)</span>
            </div>
        </div>

        <div style="text-align: center;">
            <button class="btn btn-danger" onclick="mod1Action('wrong')">直接进行部分分式展开</button>
            <button class="btn btn-primary" onclick="mod1Action('correct')">两边同时除以 z</button>
        </div>

        <div id="mod1-feedback" class="feedback-box"></div>
    </div>

    <!-- Module 2: Residue Method -->
    <div id="mod2" class="module">
        <div class="guide-text">
            <strong>任务：</strong> 使用“留数法”（遮盖法）求解系数 A 和 B。<br>
            <strong>操作：</strong> 将鼠标悬停在下方的 <span style="border-bottom: 2px dashed var(--primary)">A</span> 或 <span style="border-bottom: 2px dashed var(--primary)">B</span> 上，观察计算过程。
        </div>

        <div class="math-display">
            <div class="fraction">
                <span class="numerator">X(z)</span>
                <span class="denominator">z</span>
            </div>
            <span class="math-symbol"> = </span>
            <div class="fraction">
                <span class="numerator">z</span>
                <span class="denominator">(z-1)(z-2)</span>
            </div>
            <span class="math-symbol"> = </span>
            <div class="fraction">
                <span class="numerator term-box" onmouseover="showResidue('A')" onmouseout="hideResidue()">A</span>
                <span class="denominator">z-1</span>
            </div>
            <span class="math-symbol"> + </span>
            <div class="fraction">
                <span class="numerator term-box" onmouseover="showResidue('B')" onmouseout="hideResidue()">B</span>
                <span class="denominator">z-2</span>
            </div>
        </div>

        <!-- Visualization of the Cover-up Method -->
        <div id="residue-viz" class="calculation-card">
            <h3>计算演示：</h3>
            <div id="residue-content" class="math-display" style="font-size: 1.2rem; margin: 10px 0;">
                <!-- Content injected by JS -->
            </div>
            <p id="residue-desc" style="text-align: center; color: #64748b;"></p>
        </div>
        
        <div style="text-align: center; margin-top: 30px;">
             <p style="font-size: 0.9rem; color: #64748b;">计算完成后，记得将式子乘以 z 还原回去。</p>
             <button class="btn btn-success" onclick="unlockMod3()">系数已求出，进入最后一步</button>
        </div>
    </div>

    <!-- Module 3: ROC -->
    <div id="mod3" class="module">
        <div class="guide-text">
            <strong>任务：</strong> 不同的收敛域 (ROC) 对应不同的时域序列。<br>
            <strong>操作：</strong> 拖动滑块改变 ROC 半径，观察 Z 平面阴影变化和时域表达式的变化。
        </div>

        <div class="viz-container">
            <!-- Z-Plane Visualization -->
            <div class="canvas-wrapper">
                <svg width="300" height="300" viewBox="-150 -150 300 300" id="zplane">
                    <!-- Axes -->
                    <line x1="-140" y1="0" x2="140" y2="0" stroke="#94a3b8" stroke-width="1" />
                    <line x1="0" y1="-140" x2="0" y2="140" stroke="#94a3b8" stroke-width="1" />
                    <text x="130" y="-5" font-size="12" fill="#64748b">Re</text>
                    <text x="5" y="-130" font-size="12" fill="#64748b">Im</text>
                    
                    <!-- Poles -->
                    <!-- Pole at 1 (scale 40px = 1 unit) -->
                    <text x="35" y="4" class="pole-marker" fill="#dc2626" font-size="14">×</text>
                    <text x="35" y="20" font-size="10" fill="#dc2626">1</text>
                    
                    <!-- Pole at 2 (scale 40px = 1 unit) -->
                    <text x="75" y="4" class="pole-marker" fill="#dc2626" font-size="14">×</text>
                    <text x="75" y="20" font-size="10" fill="#dc2626">2</text>

                    <!-- ROC Dynamic Region -->
                    <path id="roc-path" d="" fill="rgba(37, 99, 235, 0.2)" stroke="var(--primary)" stroke-dasharray="4" />
                </svg>
            </div>

            <!-- Controls & Result -->
            <div class="control-panel">
                <label for="roc-slider"><strong>ROC 半径 (r): <span id="roc-val">2.5</span></strong></label>
                <input type="range" id="roc-slider" min="0" max="3.5" step="0.1" value="2.5" oninput="updateROC()">
                
                <div style="margin-top: 15px;">
                    <strong>当前区域性质：</strong>
                    <span id="region-type" style="color: var(--primary); font-weight: bold;">ROC: |z| > 2 (右边序列)</span>
                </div>

                <div class="result-equation">
                    x(n) = <span id="time-eq" style="font-family: 'Times New Roman';">...</span>
                </div>
                
                <div style="font-size: 0.9rem; color: #64748b; margin-top: 10px;">
                    <ul style="padding-left: 20px;">
                        <li><span class="math-font">|z| > 2</span>: 极点 1,2 均在圆内 &rarr; 均为右边序列 <span class="math-font">u(n)</span></li>
                        <li><span class="math-font">1 < |z| < 2</span>: 极点 1 在内，2 在外 &rarr; <span class="math-font">1<sup>n</sup></span> 是右边，<span class="math-font">2<sup>n</sup></span> 是左边</li>
                        <li><span class="math-font">|z| < 1</span>: 极点 1,2 均在圆外 &rarr; 均为左边序列 <span class="math-font">-u(-n-1)</span></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- State Management ---
    let currentState = {
        mod1Solved: false,
        mod2Solved: false
    };

    // --- Tab Switching Logic ---
    function switchTab(id) {
        // Validation logic
        if (id === 2 && !currentState.mod1Solved) {
            alert("请先完成第一步：找到正确的展开形式。");
            return;
        }
        if (id === 3 && !currentState.mod2Solved) {
            alert("请先在第二步中理解系数求解过程，并点击确认按钮。");
            return;
        }

        // UI Switching
        document.querySelectorAll('.module').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById('mod' + id).classList.add('active');
        document.querySelectorAll('.tab-btn')[id-1].classList.add('active');
    }

    // --- Module 1 Logic ---
    function mod1Action(action) {
        const feedback = document.getElementById('mod1-feedback');
        const display = document.getElementById('eq1-display');
        
        feedback.style.display = 'block';
        feedback.className = 'feedback-box';

        if (action === 'wrong') {
            feedback.classList.add('feedback-error');
            feedback.innerHTML = `
                <strong>错误警告！</strong><br>
                <div style="margin: 10px 0;">
                    如果直接展开，你会得到：<br>
                    <span class="math-font" style="font-size: 1.1rem;">
                        X(z) = 
                        <div class="fraction" style="vertical-align: middle;">
                            <span class="numerator">A</span>
                            <span class="denominator">z-1</span>
                        </div>
                        +
                        <div class="fraction" style="vertical-align: middle;">
                            <span class="numerator">B</span>
                            <span class="denominator">z-2</span>
                        </div>
                    </span>
                </div>
                最后查表时，你会发现标准公式 
                <span class="math-font">
                    <div class="fraction" style="vertical-align: middle; transform: scale(0.8);">
                        <span class="numerator">z</span>
                        <span class="denominator">z-a</span>
                    </div>
                    ↔ a<sup>n</sup>u(n)
                </span>
                需要分子有一个 <strong>z</strong>。<br>
                这里 X(z) 的展开式分子是常数，导致无法直接查表。
            `;
        } else {
            feedback.classList.add('feedback-success');
            feedback.innerHTML = `
                <strong>正确！</strong><br>
                为了构造标准形式，我们先将两边除以 <span class="math-font">z</span>。<br>
                这样得到：<br>
                <div style="margin: 10px 0; font-family: 'Times New Roman', serif; font-size: 1.1rem;">
                    <div class="fraction" style="vertical-align: middle;">
                        <span class="numerator">X(z)</span>
                        <span class="denominator">z</span>
                    </div>
                    =
                    <div class="fraction" style="vertical-align: middle;">
                        <span class="numerator">z</span>
                        <span class="denominator">(z-1)(z-2)</span>
                    </div>
                </div>
                展开后再乘回 <span class="math-font">z</span>，分子就会自动出现 <span class="math-font">z</span> 了！
            `;
            // Animate Equation Change
            display.innerHTML = `
                <div class="fraction">
                    <span class="numerator">X(z)</span>
                    <span class="denominator" style="color:var(--success); font-weight:bold;">z</span>
                </div>
                <span class="math-symbol"> = </span>
                <div class="fraction">
                    <span class="numerator">z</span>
                    <span class="denominator">(z-1)(z-2)</span>
                </div>
            `;
            
            currentState.mod1Solved = true;
            document.getElementById('btn-tab-2').disabled = false;
            
            setTimeout(() => {
                const nextBtn = document.createElement('button');
                nextBtn.className = 'btn btn-success';
                nextBtn.innerText = '下一步：求系数';
                nextBtn.onclick = () => switchTab(2);
                feedback.appendChild(document.createElement('br'));
                feedback.appendChild(nextBtn);
            }, 500);
        }
    }

    // --- Module 2 Logic ---
    function showResidue(variable) {
        const card = document.getElementById('residue-viz');
        const content = document.getElementById('residue-content');
        const desc = document.getElementById('residue-desc');
        
        card.classList.add('visible');
        
        if (variable === 'A') {
            // A corresponds to pole at z=1
            content.innerHTML = `
                <span>A = </span>
                <span class="math-symbol"> (z-1) </span>
                <span class="math-symbol"> × </span>
                <div class="fraction">
                    <span class="numerator"><span class="sub-val">1</span></span>
                    <span class="denominator"><span class="cover-up">(z-1)</span>(<span class="sub-val">1</span>-2)</span>
                </div>
                <span class="math-symbol"> = </span>
                <span> -1 </span>
            `;
            desc.innerHTML = `<strong>遮盖法：</strong> 求 <span class="math-font">z-1</span> 对应的系数时，遮住原式分母中的 <span class="math-font">(z-1)</span>，并将 <span class="math-font">z=1</span> 代入剩余部分。`;
        } else {
            // B corresponds to pole at z=2
            content.innerHTML = `
                <span>B = </span>
                <span class="math-symbol"> (z-2) </span>
                <span class="math-symbol"> × </span>
                <div class="fraction">
                    <span class="numerator"><span class="sub-val">2</span></span>
                    <span class="denominator">(<span class="sub-val">2</span>-1)<span class="cover-up">(z-2)</span></span>
                </div>
                <span class="math-symbol"> = </span>
                <span> 2 </span>
            `;
            desc.innerHTML = `<strong>遮盖法：</strong> 求 <span class="math-font">z-2</span> 对应的系数时，遮住原式分母中的 <span class="math-font">(z-2)</span>，并将 <span class="math-font">z=2</span> 代入剩余部分。`;
        }
    }

    function hideResidue() {
        // Optional: Keep it visible or hide on mouseout. 
    }

    function unlockMod3() {
        currentState.mod2Solved = true;
        document.getElementById('btn-tab-3').disabled = false;
        switchTab(3);
        // Initialize ROC
        updateROC();
    }

    // --- Module 3 Logic ---
    function updateROC() {
        const r = parseFloat(document.getElementById('roc-slider').value);
        document.getElementById('roc-val').innerText = r.toFixed(1);
        
        const path = document.getElementById('roc-path');
        const regionText = document.getElementById('region-type');
        const timeEq = document.getElementById('time-eq');
        
        const scale = 40; // 40px = 1 unit
        
        let formula = "";
        
        if (r > 2) {
            // Region 1: |z| > 2
            path.setAttribute("d", `M 0 0 M -150 -150 H 150 V 150 H -150 Z M 0 -${2*scale} A ${2*scale} ${2*scale} 0 1 0 0 ${2*scale} A ${2*scale} ${2*scale} 0 1 0 0 -${2*scale}`);
            path.setAttribute("fill-rule", "evenodd");
            regionText.innerHTML = "ROC: <span class='math-font'>|z| > 2</span> (右边序列)";
            regionText.style.color = "var(--success)";
            
            formula = "[-1 + 2(2)<sup>n</sup>]u(n)";
        } else if (r > 1) {
            // Region 2: 1 < |z| < 2
            path.setAttribute("d", `M 0 -${2*scale} A ${2*scale} ${2*scale} 0 1 0 0 ${2*scale} A ${2*scale} ${2*scale} 0 1 0 0 -${2*scale} M 0 -${1*scale} A ${1*scale} ${1*scale} 0 1 1 0 ${1*scale} A ${1*scale} ${1*scale} 0 1 1 0 -${1*scale}`);
             path.setAttribute("fill-rule", "evenodd");
            regionText.innerHTML = "ROC: <span class='math-font'>1 < |z| < 2</span> (双边序列)";
            regionText.style.color = "#eab308"; // yellow-dark
            
            formula = "-1u(n) - 2(2)<sup>n</sup>u(-n-1)";
        } else {
            // Region 3: |z| < 1
            path.setAttribute("d", `M 0 -${1*scale} A ${1*scale} ${1*scale} 0 1 1 0 ${1*scale} A ${1*scale} ${1*scale} 0 1 1 0 -${1*scale}`);
            path.setAttribute("fill-rule", "nonzero");
            regionText.innerHTML = "ROC: <span class='math-font'>|z| < 1</span> (左边序列)";
            regionText.style.color = "var(--danger)";
            
            formula = "u(-n-1) - 2(2)<sup>n</sup>u(-n-1)";
        }
        
        timeEq.innerHTML = formula;
    }
</script>

</body>
</html>